# 用戶數量限制功能說明

## 📋 功能概述

本系統已實現用戶數量限制功能，可有效控制通過 Google 登入進行註冊的新用戶數量，確保系統在上線初期能夠控制負載並維持服務品質。

## 🚀 主要功能

### 1. 自動註冊控制
- **智能攔截**：當用戶數量達到設定上限時，自動阻止新用戶通過 Google 登入註冊
- **用戶友好**：為被拒絕的用戶顯示清楚的錯誤訊息
- **現有用戶保護**：已有帳號的用戶連結 Google 帳號不受影響

### 2. 管理員後台監控
- **實時統計**：在 Django Admin 中顯示詳細的用戶數量統計
- **視覺化儀表板**：包含進度條、狀態指示器和詳細統計數據
- **狀態警告**：當接近或達到上限時顯示相應警告

### 3. 登入頁面狀態提示
- **動態提示**：根據系統使用率顯示不同等級的狀態訊息
- **用戶引導**：為接近上限時的用戶提供清楚的說明
- **視覺反饋**：禁用 Google 註冊按鈕當系統達到上限

### 4. 命令行工具
- **詳細統計**：提供完整的用戶數量分析報告
- **管理便利**：支援查看最近註冊用戶和設定新的限制

## ⚙️ 配置說明

### 環境變數設定

在專案的 `.env` 文件中添加：

```bash
# 用戶數量上限設定（預設：200）
MAX_USERS_LIMIT=200
```

### 設定檔參數

在 `RAGPilot/settings.py` 中已自動加載：

```python
# 用戶數量限制設定
MAX_USERS_LIMIT = int(os.getenv('MAX_USERS_LIMIT', 200))
```

## 🔧 使用方法

### 1. 查看用戶統計

**方法一：Django Admin**
1. 以管理員身份登入 `/admin/`
2. 進入「個人資料管理」頁面
3. 查看頁面頂部的統計卡片

**方法二：命令行工具**
```bash
# 查看基本統計
python manage.py user_stats

# 查看最近 30 天的註冊情況
python manage.py user_stats --recent 30

# 建議設定新的限制
python manage.py user_stats --limit 300
```

### 2. 調整用戶上限

1. **修改環境變數**：
   ```bash
   # 在 .env 文件中修改
   MAX_USERS_LIMIT=300
   ```

2. **重啟服務**：
   ```bash
   # 重啟 Django 服務使設定生效
   daphne -p 8000 -b 0.0.0.0 RAGPilot.asgi:application
   ```

3. **驗證設定**：
   ```bash
   python manage.py user_stats
   ```

## 📊 狀態等級說明

| 使用率 | 狀態 | 顏色 | 行為 |
|--------|------|------|------|
| < 80% | 🟢 正常 | 綠色 | 正常註冊 |
| 80-89% | 🟡 使用偏高 | 黃色 | 顯示提示，正常註冊 |
| 90-94% | 🟠 接近上限 | 橙色 | 顯示警告，正常註冊 |
| 95-99% | ⚠️ 名額緊張 | 橙色 | 顯示警告，正常註冊 |
| ≥ 100% | 🔴 已達上限 | 紅色 | **阻止新用戶註冊** |

## 🛡️ 安全特性

### 1. 精確控制
- **只限制新註冊**：現有用戶的所有功能不受影響
- **管理員豁免**：管理員可隨時手動創建用戶
- **連結操作保護**：已有用戶連結 Google 帳號不受限制

### 2. 用戶體驗
- **清楚提示**：被拒絕的用戶會看到明確的說明訊息
- **狀態透明**：在登入頁面顯示系統狀態
- **視覺反饋**：達到上限時禁用註冊按鈕

### 3. 系統監控
- **實時統計**：即時反映用戶數量變化
- **歷史追蹤**：記錄最近註冊用戶的詳細資訊
- **狀態警報**：提前預警接近上限的情況

## 🔍 故障排除

### 1. 限制不生效
```bash
# 檢查設定是否正確載入
python manage.py shell
>>> from django.conf import settings
>>> print(settings.MAX_USERS_LIMIT)
```

### 2. 統計數據異常
```bash
# 手動檢查用戶數量
python manage.py shell
>>> from django.contrib.auth import get_user_model
>>> User = get_user_model()
>>> print(f"總用戶數：{User.objects.count()}")
```

### 3. 重置限制
```bash
# 臨時提高限制（需要重啟服務）
echo "MAX_USERS_LIMIT=500" >> .env

# 或者在設定檔中直接修改
# RAGPilot/settings.py
MAX_USERS_LIMIT = 500
```

## 📝 注意事項

1. **設定變更**：修改 `MAX_USERS_LIMIT` 後需要重啟 Django 服務才能生效
2. **數據庫一致性**：用戶數量統計基於 Django User 模型的實際記錄
3. **管理員權限**：管理員始終可以通過 Django Admin 手動創建用戶
4. **現有用戶影響**：此功能不會影響已註冊用戶的任何操作
5. **社交帳號連結**：已有用戶連結 Google 或其他社交帳號不受限制

## 🚀 上線建議

1. **預設設定**：建議初始設定為 200 人，根據實際情況調整
2. **監控頻率**：建議每日檢查用戶統計，特別是接近上限時
3. **預警機制**：當使用率達到 90% 時開始密切關注
4. **彈性調整**：根據系統負載能力適時調整上限設定

---

**系統狀態檢查**：
```bash
python manage.py user_stats
```

**快速設定**：
```bash
echo "MAX_USERS_LIMIT=200" >> .env
```

這個用戶限制系統將幫助您在系統上線初期有效控制用戶數量，確保服務品質和系統穩定性。 